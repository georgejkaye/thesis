\section{Restriction equation}

Using encoders and decoders and their associated equations allows us to map
between equivalent interpretations of a circuit.
In order to obtain a (pseudo-)normal form for circuits there needs to be a
canonical such encoding for any circuit behaviour.
We already have a suitable candidate for this: the image of
\(\mealytocircuiti\), the map from Mealy machines to circuits.
Circuits in this image are already in normalised Mealy form, so this is a good
start.
However, they are more specialised than that: their internal states are made up
only of \(\bot\) and \(\top\) elements, and the width of the state is equal to
the number of stream derivatives the original stream function had including
itself.
We will establish this as our pseudo-normal form for circuits; depending on the
ordering of the states picked, there may be multiple such circuits.

\begin{corollary}
    Given a circuit \(
    \iltikzfig{strings/category/f}[box=f,colour=seq]
    \), there exists at least one word \(\listvar{s} \in \{\bot,\top\}^x\) and
    normalised circuit \(
    \iltikzfig{strings/category/f}[box=g,colour=comb]
    \) such that \(
    \circuittostreami[\iltikzfig{strings/category/f}[box=f,colour=seq]]
    =
    \circuittostreami[\iltikzfig{circuits/productivity/mealy-form}[core=|g|,colour=seq]]
    \).
\end{corollary}

By \cref{thm:possible-encodings}, we have that there is an encoding that maps
state sets between denotationally equivalent circuits.
If we can encode a circuit's state sets to one where the states are all elements
of \(\{\bot,\top\}^x\), does this mean we have a sound and complete equational
theory?
Unfortunately not: all it means is that the circuits agree on the set of
circuit states.

\begin{example}
    Consider the following two circuits in \(\scirc{\belnapsignature}\): \[
        \iltikzfig{circuits/examples/state-change/circuit-mealy}
        \quad
        \iltikzfig{circuits/examples/state-change/circuit-simpler-mealy}
    \]
    These circuits both have circuit states \(
    \{\belnaptrue\belnapfalse,\belnapfalse\belnaptrue\}
    \), but their combinational cores do \emph{not} have the same semantics!
    They only act the same because they receive certain inputs.
\end{example}

The final family of equations required is one for mapping between combinational
circuits that agree on the context, but may differ otherwise.

\begin{notation}
    Given sets \(A\), \(B\) and \(C\) where \(C \subseteq A\) and a function
    \(\morph{f}{A}{B}\), the \emph{restriction of \(f\) to \(C\)} is a function
    \(\morph{f|C}{C}{B}\), defined as \(f|C(c) \coloneqq f(c)\).
\end{notation}

\begin{definition}[Restriction equation]
    Let the \emph{restriction equation} be defined as in
    \cref{fig:restriction-equation}.
\end{definition}

\input{sections/circuits/algebraic/floats/restriction-equation}

It is now possible to collect all the equations together and define a sound and
complete algebraic theory of sequential digital circuits.

\begin{definition}
    For an interpretation \(\interpretation\), let
    \(\mce_{\interpretation}\) be defined as \(
    \mealyequations +
    \instantfeedbackeqn +
    \normalisingequations +
    \encodingequations +
    \restrictionequation
    \), and let \(\scircsigmae\) be defined as
    \(\scircsigma / \mce_{\interpretation}\).
\end{definition}

\begin{theorem}
    For a functionally complete interpretation \(\interpretation\), \(
    \iltikzfig{strings/category/f}[box=f,colour=seq,dom=\listvar{m},cod=\listvar{n}]
    =
    \iltikzfig{strings/category/f}[box=g,colour=seq,dom=\listvar{m},cod=\listvar{n}]
    \) in \(\scircsigmae\) if and only if \(
    \circuittostreami[
        \iltikzfig{strings/category/f}[box=f,colour=seq,dom=\listvar{m},cod=\listvar{n}]
    ]
    =
    \circuittostreami[
        \iltikzfig{strings/category/f}[box=g,colour=seq,dom=\listvar{m},cod=\listvar{n}]
    ]
    \).
\end{theorem}
\begin{proof}
    All the equations are sound, so we only need to consider the \(\ifdir\)
    direction.
    By \cref{lem:normalised-mealy}, the two circuits can be brought to
    normalised Mealy form using
    \(
    \mealyequations +
    \instantfeedbackeqn +
    \normalisingequations
    \).
    By \cref{def:mealy-to-circuit} and
    \cref{thm:circuit-stream-correspondence} there must exist a circuit \(
    \iltikzfig{strings/category/f}[box=h,colour=seq]
    \coloneqq
    \iltikzfig{circuits/algebraic/encoding}[transition={h_0},output={h_1},state={\listvar{s}}]
    \) such that \(
    \circuittostream[
        \iltikzfig{strings/category/f}[box=f,colour=seq]
    ]{\interpretation}
    =
    \circuittostream[
        \iltikzfig{strings/category/f}[box=h,colour=seq]
    ]{\interpretation}
    =
    \circuittostream[
        \iltikzfig{strings/category/f}[box=g,colour=seq]
    ]{\interpretation}
    \).
    The circuit \(
    \iltikzfig{strings/category/f}[box=H,colour=seq]
    \) is encoded such that the state words are in the image of
    \(\gamma_\leq\).
    This means that applying the encoding equation with \(\leq\) to the
    normalised Mealy forms obtained above will yield the circuit \(
    \iltikzfig{strings/category/f}[box=h,colour=seq]
    \).
\end{proof}

As always, the soundness and completeness of the algebraic semantics means we
can establish another isomorphism of PROPs.

\begin{corollary}
    \(\scircsigmai \cong \scircsigmae\).
\end{corollary}

This brings our jaunt into algebraic semantics to a close; given a circuit \(
\iltikzfig{strings/category/f}[box=f,colour=seq,dom=\listvar{m},cod=\listvar{n}]
\) we know that we can translate it into another circuit \(
\iltikzfig{strings/category/f}[box=g,colour=seq,dom=\listvar{m},cod=\listvar{n}]
\) with the same behaviour by only using equations in \(\mce_\interpretation\).

Of course, the procedure of using the normalisation equations to translate a
circuit into normalised Mealy form before using the encoding equation (possibly
multiple times depending on how lucky one gets with their orderings) may be
tedious; one might wonder how this is beneficial to the operational approach in
the previous chapter.
But the beauty of the \emph{algebraic} semantics is that we \emph{don't} need to
do this every time!
Equations can be proven as lemmas and then used repeatedly in the future as
`shortcuts', possibly saving many reasoning steps.
In time, the algebraicist will build up a powerful repertoire of equations and
wield them to bend circuits to their will.