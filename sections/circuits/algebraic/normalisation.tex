\section{Normalising circuits}

How does one start when trying to define a complete set of equations for some
framework?
Usually the strategy is to define enough equations to bring any term to some
sort of (pseudo-)\emph{normal form}; the theory is then complete if terms with
the same semantics have the same normal form.

We have already seen something that looks a bit like a normal form: the
\emph{Mealy form} from the previous section.
This is by no means a true normal form, as there are many different Mealy forms
that represent the same behaviour.
Nevertheless, it is a useful starting point so we will need equations to bring
circuits to Mealy form in our theory.

We could just naively port across the Mealy rules from the operational semantics
by changing the squiggly arrow into an equals sign and hoping nobody notices,
but we are better people than that.
Instead we will show how Mealy form can be derived using a finite set of
equations, rather than resorting to equations parameterised over all circuits.

\input{sections/circuits/algebraic/floats/mealy-equations}

\begin{definition}
    The set \(\mealyequations\) of \emph{Mealy equations} in
    \cref{fig:mealy-equations} are sound.
\end{definition}
\begin{proof}
    The first two rules hold as the join is a monoid in the stream semantics.
    The \((\bottomdelayeqn)\) holds because the semantics of the delay
    component are to output a \(\bot\) value first and then the (delayed)
    inputs: as the semantics of the \(
    \iltikzfig{strings/structure/monoid/init}[colour=comb]
    \) component are to \emph{always} produce \(\bot\), then it does not make a
    difference how delayed it is.
    The final equation is just the instant feedback rule from the previous
    chapter, which is sound by \cref{prop:instant-feedback}.
\end{proof}

\begin{proposition}\label{prop:mealy-equations}
    Given a sequential circuit \(
    \iltikzfig{strings/category/f}[box=F,colour=seq]
    \), there exists a circuit in Mealy form such that \(
    \iltikzfig{strings/category/f}[box=F,colour=seq]
    =
    \iltikzfig{circuits/productivity/mealy-form}
    \) in \(\scircsigma / \mealyequations\).
\end{proposition}
\begin{proof}
    Any circuit can be assembled into global trace-delay form solely using the
    axioms of STMCs, which hold by default in \(\scircsigma\).
    From this, a circuit in pre-Mealy form can be obtained by translating
    delays into registers using \(
    \iltikzfig{circuits/axioms/delay-to-register/step-0}
    \eqaxioms[(\monoidunitleqn)]
    \iltikzfig{circuits/axioms/delay-to-register/step-1}
    \) and translating values into registers using \(
    \iltikzfig{circuits/axioms/value-to-register/step-0}
    \eqaxioms[(\monoidunitreqn)]
    \iltikzfig{circuits/axioms/value-to-register/step-1}
    \eqaxioms[(\bottomdelayeqn)]
    \iltikzfig{circuits/axioms/value-to-register/step-2}
    \).
    Subsequently a circuit in Mealy form can be obtained by applying the
    \((\instantfeedbackeqn)\) rule.
\end{proof}

\(\scircsigma / \mealyequations\) is a category in which all circuits are equal
to at least one circuit in Mealy form.
In general, there will be many Mealy forms depending on the ordering one picks
for the delays and values.

One subclass of circuits in Mealy form which is particularly special is the
image of \(\mealytocircuiti\), the map from Mealy machines to circuit morphisms.
Recall that circuits in the image of \(\mealytocircuiti\) are in the form \(
\iltikzfig{circuits/synthesis/mealy-term-spaced}[trace=\listvar{x},dom=\listvar{m},cod=\listvar{n}]
\), where \(\gamma_\leq\) is an \emph{encoding} of the state set with respect
to some total order \(\leq\).
This encoding maps states to words containing only \(\bot\) and \(\top\) where
the width of each word is equal to the number of states in the original Mealy
machine.

From the completeness procedure for the denotational semantics, we know that any
circuit is guaranteed to be denotationally equivalent to a circuit in this form;
if we have equations to translate any circuits with the same behaviour to this
circuit, then we have a complete algebraic semantics.

The map from Mealy machines to circuits also enforces the structure of the
Mealy core: it must be in the image of the map \(\mealytofunc\) from \(\funci\)
to \(\scircsigma\).
For a given interpretation this map essentially specifies the `canonical'
version of any combinational circuit.
So as not to work with arbitrary cores, it is preferable to first translate
combinational circuits into this canonical circuit; this allows us to restrict
the class of circuits any future equations must apply to.

\begin{definition}[Normalised circuit]
    A sequential circuit \(
    \iltikzfig{strings/category/f}[box=f,colour=seq,dom=\listvar{m},cod=\listvar{n}]
    \) is \emph{normalised} if it is in the image of \(\mealytofunc\).
\end{definition}

\begin{remark}
    Recall that even though \(\mealytofunc\) maps into \(\scircsigma\), every
    circuit in its image has combinational behaviour; the image of
    \(\mealytofunc\) is constrained in such a way that the instantaneous values
    can be used as constants.
\end{remark}

As the normalised version of a given circuit is interpretation-dependent, there
is no standard set of equations for normalising a circuit.
Instead, these must be specified on a interpretation-by-interpretation basis.

\begin{definition}[Normalising equations]
    For a functionally complete interpretation \(\interpretation\), a set of
    equations \(\normalisingequations\) is \emph{normalising} if any
    compositional circuit \(
    \iltikzfig{strings/category/f}[box=f,colour=comb,dom=\listvar{m},cod=\listvar{n}]
    \) is equal to a circuit in the image of \(\mealytofunc\) by equations in
    \(\normalisingequations\).
\end{definition}

The aim of the normalising equations for an interpretation translate a
combinational core into a form from which it is easy to read off a truth table.

\subsection{Case study: The Belnap interpretation}\label{sec:algebraic-case-study}

\todo[inline]{The normalising equations for the Belnap interpretation}
