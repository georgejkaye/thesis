\section{Rewriting with traced structure}

In the Frobenius setting, every pushout complement is a valid rewrite, but there
is no reason for the same to be the case for traced or traced comonoid
rewriting.
Bonchi et al showed in~\cite{bonchi2022stringa} that \emph{exactly one} pushout
complement corresponds to a valid rewrite in the symmetric monoidal case by
characterising it as a \emph{boundary complement}.

\begin{definition}[Boundary complement (\cite{bonchi2022stringa}, Def. 30)]
    For monogamous cospans \(
    \cospan{\listvar{i}}[a_1]{L}[a_2]{\listvar{j}}
    \) and \(
    \cospan{\listvar{m}}[b_1]{G}[b_2]{\listvar{n}}
    \) and a monomorphism \(\morph{f}{L}{G}\), a pushout complement as below
    \begin{center}
        \begin{tikzcd}[column sep=large]
            L \arrow[swap]{d}{f}
            &
            \listvar{ij}
            \arrow[swap]{l}{a \coloneqq [a_1, a_2]}
            \arrow{d}{c \coloneqq [c_1, c_2]}
            \\
            G
            \arrow["\urcorner"{anchor=center, pos=0.125}, draw=none]{ur}
            &
            C
            \arrow{l}{g}
            \\
            &
            \listvar{mn}
            \arrow{ul}{[b_1,b_2]}
            \arrow[swap]{u}{d \coloneqq [d_1,d_2]}
        \end{tikzcd}
    \end{center}
    is called a \emph{boundary complement} if \(c_1\) and \(c_2\) are
    mono and \(
    \cospan{\listvar{jm}}[[c_2,d_1]]{C}[[d_2,c_1]]{\listvar{ni}}
    \) is a boundary monogamous cospan.
\end{definition}

What is particularly special about boundary complements is that for morphisms
\(\listvar{ij} \to L \to G\) there is always \emph{exactly one} pushout
complement which is also a boundary complement!

\begin{proposition}[\cite{bonchi2022stringa}, Prop. 31]
    When boundary complements exist in \(\hypsigmac\), they are unique.
\end{proposition}

For rewriting in a traced setting, boundary complements are too strong, so we
will weaken them to \emph{traced} boundary complements, replacing references to
monogamy with partial monogamy.

\begin{definition}[Traced boundary complement]
    \label{def:traced-boundary-complement}
    For partial monogamous cospans \(
    \cospan{\listvar{i}}[a_1]{L}[a_2]{\listvar{j}}
    \) and \(
    \cospan{\listvar{m}}[b_1]{G}[b_2]{\listvar{n}}
    \), a pushout complement as below
    \begin{center}
        \begin{tikzcd}[column sep=large]
            L \arrow[swap]{d}{f}
            &
            \listvar{ij}
            \arrow[swap]{l}{a \coloneqq [a_1, a_2]}
            \arrow{d}{c \coloneqq [c_1, c_2]}
            \\
            G
            \arrow["\urcorner"{anchor=center, pos=0.125}, draw=none]{ur}
            &
            C
            \arrow{l}{g}
            \\
            &
            \listvar{mn}
            \arrow{ul}{[b_1,b_2]}
            \arrow[swap]{u}{d \coloneqq [d_1,d_2]}
        \end{tikzcd}
    \end{center}
    is called a \emph{traced boundary complement} if \(c_1\) and \(c_2\) are
    mono and \(
    \cospan{\listvar{jm}}[[c_2,d_1]]{C}[[d_2,c_1]]{\listvar{ni}}
    \) is a partial monogamous cospan.
\end{definition}

By restricting to traced boundary complements, DPO rewriting can be formulated
for terms in a traced setting.

\begin{definition}[Traced DPO]
    For morphisms \(G \leftarrow \listvar{mn}\) and \(H \leftarrow \listvar{mn}\) in
    \(\hypsigma\), there is a traced rewrite \(G \trgrewrite[\mcr] H\) if there
    exists a rule \(
    \spann{L}{\listvar{ij}}{R} \in \mcr
    \) and cospan \(
    \cospan{\listvar{ij}}{C}{\listvar{mn}} \in \hypsigma
    \) such that diagram in \cref{def:dpo-rewriting} commutes and \(\listvar{ij} \to C\)
    is a traced boundary complement.
\end{definition}

Traced boundary complements are not much more powerful than regular boundary
complements; \(c_1\) is still not permitted to merge vertices in the inputs and
the same for \(c_2\) and the outputs.
The real power of traced DPO, and what increases the number of pushout
complements, is the fact that the matching \(L \to G\) is no longer required to
be mono.

Since \(\cospan{\listvar{m}}{G}{\listvar{n}}\) is partial monogamous, vertices
in \(L\) can only be merged if their degrees sum to no more than \((1,1)\).
Merging vertices in this way corresponds to using the trace to find a match.

\begin{example}
    Consider the rule \(
    \rrule{
        \iltikzfig{graphs/dpo/traced-example/rule-lhs}
    }{
        \iltikzfig{graphs/dpo/traced-example/rule-rhs}
    }
    \) and the term \(
    \iltikzfig{graphs/dpo/traced-example/term}
    \), in which there is clearly an instance of the rule.
    The interpretation of this as a DPO derivation with a valid traced boundary
    complement is illustrated below.
    \begin{center}
        \includestandalone{figures/graphs/dpo/traced-example/rewrite}
    \end{center}
\end{example}

A key feature of rewriting modulo traced structure is the \emph{yanking} axiom,
which can lead to some non-obvious rewrites.

\begin{example}
    Consider the rule \(
    \rrule{
        \iltikzfig{graphs/dpo/split-loop/rule-lhs}
    }{
        \iltikzfig{graphs/dpo/split-loop/rule-rhs}
    }
    \).
    The interpretation of this as a DPO rule in a valid traced boundary
    complement is illustrated below.
    \begin{center}
        \includestandalone{figures/graphs/dpo/split-loop/rewrite}
    \end{center}
    This corresponds to a valid term rewrite:
    \[
        \iltikzfig{graphs/dpo/split-loop/derivation-1}
        =
        \iltikzfig{graphs/dpo/split-loop/derivation-2}
        =
        \iltikzfig{graphs/dpo/split-loop/derivation-3}
        =
        \iltikzfig{graphs/dpo/split-loop/derivation-4}
    \]

    Note that applying yanking is required in the term setting because
    the traced wire is flowing from right to left, whereas applying the rule
    requires all wires flowing left to right.
\end{example}

Use of yanking is also what can lead to multiple boundary complements, and hence
a choice in rewrites.

\begin{example}
    Consider the rule \(
    \rrule{
        \iltikzfig{graphs/dpo/non-unique/rule-lhs}
    }{
        \iltikzfig{graphs/dpo/non-unique/rule-rhs}
    }
    \).
    Below are two valid traced boundary complements involving a matching of this
    rule.

    \begin{center}
        \scalebox{0.95}{\includestandalone{figures/graphs/dpo/non-unique/rewrite-1}}
        \quad
        \scalebox{0.95}{\includestandalone{figures/graphs/dpo/non-unique/rewrite-2}}
    \end{center}

    These two derivations arise through yanking:
    \begin{gather*}
        \iltikzfig{graphs/dpo/non-unique/derivation-1}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-2}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-3a}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-4a}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-5a}
        \\
        \iltikzfig{graphs/dpo/non-unique/derivation-1}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-2}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-3b}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-4b}
        =
        \iltikzfig{graphs/dpo/non-unique/derivation-5b}
    \end{gather*}
\end{example}

There is another condition on graph rewriting modulo symmetric monoidal
structure in that the matching must be \emph{convex}: any path between vertices
must also be captured.
Luckily for us, this is not necessary in the traced case.

\begin{example}
    Consider the rule \(
    \rrule{
        \iltikzfig{graphs/dpo/convex/example-l}
    }{
        \iltikzfig{graphs/dpo/convex/example-r}
    }
    \) and the term \iltikzfig{graphs/dpo/convex/example-g}.
    Although it is not immediately obvious, there is in fact
    a matching of the former in the latter.
    Performing the DPO procedure yields the following:
    %
    \begin{gather*}
        \includestandalone{figures/graphs/dpo/convex/rewrite}
    \end{gather*}
    In a non-traced setting this is an invalid rule!
    However, it is possible with yanking.
    \begin{gather*}
        \iltikzfig{graphs/dpo/convex/example-g}
        =
        \iltikzfig{graphs/dpo/convex/rewrite-2}
        =
        \iltikzfig{graphs/dpo/convex/rewrite-4}
        =
        \iltikzfig{graphs/dpo/convex/rewrite-5}
        =
        \iltikzfig{graphs/dpo/convex/example-h}
    \end{gather*}
    This shows that convexity is not a required component of traced rewriting.
\end{example}

We are almost ready to show the soundness and completeness of this DPO rewriting
system; we will do this by showing that even though rewriting takes place in the
more liberal compact closed setting, the rewritten graph will always correspond
to a traced term.
First we prove a lemma to show how using the compact closed structure of
\(\smcsigmac + \frobc\) to reorganise interfaces corresponds to switching the
cospan maps in \(\cspdchyp\).

\begin{lemma}\label{lem:switch-interfaces}
    Let \(
    \iltikzfig{strings/category/f-2-2}[box=c,colour=white,dom1=\listvar{m},dom2=\listvar{n},cod1=\listvar{p},cod2=\listvar{q}]
    \) be a term in \(\smcsigmac + \frobc\).
    Then if \(
    \termandfrobtohypsigmac[
        \iltikzfig{strings/category/f-2-2}[box=c,colour=white]
    ]
    =
    \cospan{\listvar{mn}}[[f_1,f_2]]{F}[[g_1,g_2]]{\listvar{pq}}
    \) then \(
    \termandfrobtohypsigmac[
        \iltikzfig{strings/rewriting/c-folded}
    ]
    =
    \cospan{\listvar{pm}}[[g_1,f_1]]{F}[[f_2,g_2]]{\listvar{nq}}
    \).
\end{lemma}
\begin{proof}
    By definition of cups and caps in \(\cspdchyp\).
\end{proof}

We need to show that rewriting a term with a rule \(\rrule{
    \iltikzfig{strings/category/f}[box=l,colour=white]
}{
    \iltikzfig{strings/category/f}[box=r,colour=white]
}\) coincides with graph rewriting on the hypergraph interpretations of
this rule.

\begin{theorem}\label{thm:traced-rewriting}
    For a rewrite rule \(\rrule{
        \iltikzfig{strings/category/f}[box=l,colour=white]
    }{
        \iltikzfig{strings/category/f}[box=r,colour=white]
    }\) in \(
    \stmcsigmac
    \), \(
    \iltikzfig{strings/category/f}[box=g,colour=white]
    \rewrite[\rrule{
            \iltikzfig{strings/category/f}[box=l,colour=white]
        }{
            \iltikzfig{strings/category/f}[box=r,colour=white]
        }]
    \iltikzfig{strings/category/f}[box=h,colour=white]
    \) if and only if \(
    \termandfrobtohypsigmac[
        \foldinterfaces[
            \tracedtosymandfrobsigmac[
                \iltikzfig{strings/category/f}[box=g,colour=white]
            ]
        ]
    ]
    \grewrite[
        \termandfrobtohypsigmac[
            \rrule{
                \tracedtosymandfrobsigmac[
                    \iltikzfig{strings/category/f}[box=l,colour=white]
                ]
            }{
                \tracedtosymandfrobsigmac[
                    \iltikzfig{strings/category/f}[box=r,colour=white]
                ]
            }
        ]
    ]
    \termandfrobtohypsigmac[
        \foldinterfaces[
            \iltikzfig{strings/category/f}[box=g,colour=white]
        ]
    ]\).
\end{theorem}
\begin{proof}
    First the \((\Rightarrow)\) direction.
    If \(
    \iltikzfig{strings/category/f}[box=g,colour=white]
    \rewrite[\mcr]
    \iltikzfig{strings/category/f}[box=h,colour=white]
    \) then we have \(
    \iltikzfig{strings/category/f}[box=g,colour=white]
    =
    \iltikzfig{strings/rewriting/rewrite-l}
    \) and \(
    \iltikzfig{strings/rewriting/rewrite-r}
    =
    \iltikzfig{strings/category/f}[box=h,colour=white]
    \); we must derive the DPO diagram in \(\hypsigmac\).
    First we give names to the following cospans:
    \begin{alignat*}{3}
        \cospan{\varepsilon}{L}{\listvar{ij}}
         & \coloneqq
        \termandfrobtohypsigmac[
            \foldinterfaces[
                \tracedtosymandfrobsigmac[
                    \iltikzfig{strings/category/f}[box=l,colour=white]
                ]
            ]
        ]
         &           & =
        \termandfrobtohypsigmac[
            \iltikzfig{strings/rewriting/l-folded}
        ]
        \\
        \cospan{\varepsilon}{R}{\listvar{ij}}
         & \coloneqq
        \termandfrobtohypsigmac[
            \foldinterfaces[
                \tracedtosymandfrobsigmac[
                    \iltikzfig{strings/category/f}[box=r,colour=white]
                ]
            ]
        ]
         &           & =
        \termandfrobtohypsigmac[\iltikzfig{strings/rewriting/r-folded}]
        \\
        \cospan{\varepsilon}{G}{\listvar{mn}}
         & \coloneqq
        \termandfrobtohypsigmac[
            \foldinterfaces[
                \tracedtosymandfrobsigmac[
                    \iltikzfig{strings/category/f}[box=g,colour=white]
                ]
            ]
        ]
         &           & =
        \termandfrobtohypsigmac[\iltikzfig{strings/rewriting/lc-folded-shifted}]
        \\
        \cospan{\varepsilon}{H}{\listvar{mn}}
         & \coloneqq
        \termandfrobtohypsigmac[
            \foldinterfaces[
                \tracedtosymandfrobsigmac[
                    \iltikzfig{strings/category/f}[box=h,colour=white]
                ]
            ]
        ]
         &           & =
        \termandfrobtohypsigmac[\iltikzfig{strings/rewriting/rc-folded-shifted}]
    \end{alignat*}

    Moving into \(\smcsigmac + \frobc\), we have that \(
    \iltikzfig{strings/rewriting/lc-folded-shifted}
    =
    \iltikzfig{strings/rewriting/lc-folded}
    \); so by functoriality \(
    \termandfrobtohypsigmac[
        \foldinterfaces[
            \tracedtosymandfrobsigmac[
                \iltikzfig{strings/category/f}[box=g,colour=white]
            ]
        ]
    ]
    =
    \termandfrobtohypsigmac[\iltikzfig{strings/rewriting/l-folded}]
    \seq
    \termandfrobtohypsigmac[\iltikzfig{strings/rewriting/c-folded}]
    \), i.e.\ \(
    \cospan{\varepsilon}{G}{\listvar{mn}} =
    \cospan{\varepsilon}{L}{\listvar{ij}}
    \seq
    \cospan{\listvar{ij}}{C}{\listvar{mn}}
    \).
    Cospan composition is pushout, so \(\cospan{L}{G}{C}\) is a pushout.
    Using the same reasoning, \(\cospan{R}{G}{C}\) is also a pushout; this
    gives us the DPO diagram.
    All that remains is to check that the aforementioned pushouts are traced
    boundary complements; this follows as \(
    \termandfrobtohypsigmac[
        \tracedandcomonoidtofrobsigmac[
            \iltikzfig{strings/category/f-2-2}[box=c,colour=white]
        ]
    ]
    \) is partial monogamous, so by \cref{lem:switch-interfaces} the traced
    boundary complement condition holds.

    Now for the \(\ifdir\) direction: we assume that we have a traced DPO
    rewrite, so there exist cospans \(
    \cospan{\varepsilon}{L}{\listvar{ij}},
    \cospan{\varepsilon}{R}{\listvar{ij}},
    \cospan{\listvar{ij}}{C}{\listvar{mn}}
    \) as defined above such that the DPO diagram commutes and
    \(\listvar{ij} \to C \to G\) is a traced boundary complement.
    We must show that \(
    \iltikzfig{strings/category/f}[box=g,colour=white]
    =
    \iltikzfig{strings/rewriting/rewrite-l}
    \) and \(
    \iltikzfig{strings/category/f}[box=h,colour=white]
    =
    \iltikzfig{strings/rewriting/rewrite-r}
    \).

    We have that \(
    \cospan{\varepsilon}{G}{\listvar{mn}} =
    \cospan{\varepsilon}{L}{\listvar{ij}} \seq
    \cospan{\listvar{ij}}[[c_1,c_2]]{C}[[d_1,d_2]]{\listvar{mn}}
    \) as cospan composition is by pushout.
    Let \(
    \iltikzfig{strings/category/f-2-2}[box=c^\prime, colour=white,dom1=\listvar{i},dom2=\listvar{j},cod1=\listvar{m},cod2=\listvar{n}]
    \) be the term in \(\smcsigmac + \frobc\) such that \(
    \termandfrobtohypsigmac[
        \iltikzfig{strings/category/f-2-2}[box=c^\prime, colour=white]
    ]
    =
    \cospan{\listvar{ij}}[[c_1,c_2]]{C}[[d_1,d_2]]{\listvar{mn}}
    \), which exists as \(\termandfrobtohypsigmac\) is full.


    The cospan \(\cospan{\listvar{jm}}[[c_2,d_1]]{C}[[c_1,d_2]]{\listvar{in}}\)
    is partial monogamous because \(\listvar{ij} \to C \to G\) is a traced
    boundary complement.
    Let \(
    \iltikzfig{strings/category/f-2-2}[box=c, colour=white,dom1=\listvar{j},dom2=\listvar{m},cod1=\listvar{i},cod2=\listvar{n}]
    \)  be the term in \(\smcsigmac + \frobc\) such that \(
    \termandfrobtohypsigmac[
        \iltikzfig{strings/category/f-2-2}[box=c, colour=white]
    ]
    =
    \cospan{\listvar{jm}}[[c_2,d_1]]{C}[[c_1,d_2]]{\listvar{in}}
    \).
    Using \cref{lem:switch-interfaces}, we have that \(
    \termandfrobtohypsigmac[
        \iltikzfig{strings/rewriting/c-folded}
    ]
    =
    \cospan{\listvar{ij}}[[c_1,c_2]]{C}[[d_1,d_2]]{\listvar{mn}}
    \).

    So we have that \(
    \termandfrobtohypsigmac[
        \foldinterfaces[
            \iltikzfig{strings/category/f}[box=g,colour=white]
        ]
    ]
    =
    \termandfrobtohypsigmac[
        \foldinterfaces[
            \iltikzfig{strings/category/f}[box=l,colour=white]
        ]
    ]
    \seq
    \termandfrobtohypsigmac[
        \iltikzfig{strings/category/f-2-2}[box=c^\prime, colour=white]
    ]
    \); by fullness we derive that \(
    \iltikzfig{strings/rewriting/g-folded-box}
    =
    \iltikzfig{strings/rewriting/lc}
    =
    \iltikzfig{strings/rewriting/lc-folded}
    =
    \iltikzfig{strings/rewriting/lc-folded-shifted}
    \).
    This means that \(
    \foldinterfaces[
        \iltikzfig{strings/category/f}[box=g,colour=white]
    ]
    =
    \iltikzfig{strings/rewriting/lc-folded-shifted}
    \) so `unfolding' the interface gives us \(
    \iltikzfig{strings/category/f}[box=g,colour=white]
    =
    \iltikzfig{strings/rewriting/rewrite-l}
    \).
    Since \(
    \termandfrobtohypsigmac[
        \iltikzfig{strings/category/f-2-2}[box=c, colour=white]
    ]
    \) is partial monogamous, \(
    \iltikzfig{strings/category/f-2-2}[box=c, colour=white]
    \) is in \(\stmcsigmac\).
    As the trace in \(\stmcsigma\) is the canonical trace, the entire term is in
    \(\stmcsigmac\), completing the proof.
    The same procedure holds for rewriting from the other direction.
\end{proof}