\section{Traced terms}

We now turn our attention to \emph{traced} terms.
First, we establish the link between terms in a hypergraph category and a
those in a symmetric traced monoidal category.

\begin{lemma}[\cite{rosebrugh2005generic}, Prop. 2.8]
    Every hypergraph category is self-dual compact closed.
\end{lemma}
\begin{proof}
    The cup on a given object is defined as \(
        \iltikzfig{strings/compact-closed/cup-self-dual}[colour=white,obj=A]
        :=
        \iltikzfig{strings/structure/frobenius/cup}[obj=A]
    \) and the cap as \(
        \iltikzfig{strings/compact-closed/cap-self-dual}[colour=white,obj=A]
        :=
        \iltikzfig{strings/structure/frobenius/cap}[obj=A]
    \).
    The snake equations follow by applying the Frobenius equation and unitality:
    \begin{gather*}
        \iltikzfig{strings/structure/frobenius/snake-1-0}
        =
        \iltikzfig{strings/structure/frobenius/snake-1-1}
        =
        \iltikzfig{strings/structure/frobenius/snake-1-2}
        \qquad
        \iltikzfig{strings/structure/frobenius/snake-2-0}
        =
        \iltikzfig{strings/structure/frobenius/snake-2-1}
        =
        \iltikzfig{strings/structure/frobenius/snake-2-2}
        \qedhere
    \end{gather*}
\end{proof}

There are more terms in a freely generated compact closed category
than there are in a freely generated traced category, as in the former outputs
are not always required to connect to inputs.
Since cospans of hypergraphs in \(\cspdchyp\) are in correspondence with terms
in \(\hypcsigmac\), this means that there will be cospans in the former that do
not have a corresponding traced term.
However, this does not mean we need to discard all the work of the previous
section.
Instead, we can reuse the components and adapt them for our traced setting.

Since we have a map from \(\smcsigmac + \frobc\) to cospans of hypergraphs, we
need to interpret every term in \(\stmcsigmac\) in terms of components from
either \(\smcsigmac\) or \(\frobc\).

\begin{lemma}
    \label{lem:stmc-subcat-hypc}
    \(\stmcsigmac\) is a subcategory of \(\hypcsigmac\).
\end{lemma}
\begin{proof}
    Since \(\hypsigmac\) is compact closed, it has a (canonical) trace.
    For \(\stmcsigmac\) to be a subcategory of \(\hypcsigmac\), every morphism
    of the former must also be a morphism on the latter.
    Since the two categories are freely generated (with the trace constructed
    through the Frobenius generators in the latter), all that remains is to
    check that every morphism in \(\stmcsigmac\) is a unique morphism in
    \(\hypcsigmac\), i.e.\ the equations of \(\frobc\) do not merge any together.
    This is trivial since the equations do not apply to the construction of the
    canonical trace.
\end{proof}

\begin{definition}
    Let \(\morph{\tracedtosymandfrobsigmac}{\stmcsigmac}{\hypcsigmac}\) be the
    inclusion functor induced by \cref{lem:stmc-subcat-hypc}.
\end{definition}

\begin{corollary}
    \(\tracedtosymandfrobsigmac\) is faithful.
\end{corollary}

To translate a term in \(\stmcsigmac\) into a cospan of hypergraphs, one simply
applies \(\tracedtosymandfrobsigmac\) followed by \(\termandfrobtohypsigmac\).

\begin{corollary}
    \(\termandfrobtohypsigmac \circ \tracedtosymandfrobsigmac\) is faithful.
\end{corollary}

Since \(\termandfrobtohypsigmac \circ \tracedtosymandfrobsigmac\) is faithful,
every distinct traced term in \(\stmcsigmac\) has a \emph{unique} cospan of
hypergraphs up to isomorphism.
However, this functor is not clearly not \emph{full}: as we have previously
illustrated, there are more terms in \(\hypcsigmac\) than there are in
\(\stmcsigmac\).

The next step is to characterise the \emph{image} of
\(\termandfrobtohypsigmac \circ \tracedtosymandfrobsigmac\).
A similar task was performed in \cite{bonchi2022stringa} for terms in
\(\smcsigmac\); we will recall their definitions and then adapt them for our
case.

\subsection{Partial monogamy}

Since monogamous acyclic cospans correspond exactly to symmetric monoidal terms,
it is too restrictive to be used as a setting for modelling traced terms.
Clearly, we can drop the acyclicity condition, as the trace can introduce
cycles.
However, there is one foible regarding the monogamicity condition which must
also be tackled.
Although wires are also not permitted to arbitrarily fork or join in a traced
category, it is also possible to have a case where wires do not connect to
any generators while also remaining disconnected from the interfaces.
This special case is the trace of the identity, which in string diagrams is
depicted as a closed
loop \(
    \trace{1}{\iltikzfig{strings/category/identity}[colour=white]}
    =
    \iltikzfig{strings/traced/trace-id}
\).
One might think this can be discarded, in that \(
    \iltikzfig{strings/traced/trace-id}
    =
    \iltikzfig{strings/monoidal/empty}
\), but this is \emph{not} always the case; for example, it is not true
in \(\finvectk{k}\)~\cite[Sec. 6.1]{hasegawa1997recursion}.
Instead, we can model these closed loops as lone vertices (`bones') disconnected
from either interface.

\begin{definition}[Partial monogamy]
    A cospan \(\cospan{m}[f]{F}[g]{n} \in \cspdhyp\) is
    \emph{partial monogamous} if \(f\) and \(g\) are mono and, for all nodes
    \(v \in \vertices{F}\), the degree of \(v\) is
    \begin{center}
        \begin{tabular}{rlcrl}
            \((0,0)\)
            &
            if \(v \in f_\star \wedge v \in g_\star\)
            &
            \quad
            &
            \((0,1)\)
            &
            if \(v \in f_\star\)
            \\
            \((1,0)\)
            &
            if \(v \in g_\star\)
            &
            \quad
            &
            \((0,0)\)
            or \((1,1)\)
            &
            otherwise
        \end{tabular}
    \end{center}
\end{definition}

\input{floats/partial-monogamous-examples}

\begin{example}
    Examples of cospans that are and are not partial monogamous are shown
    in \cref{fig:partial-monogamous-examples}.
\end{example}

As with the monogamous acyclic cospans, a sub-PROP of \(\cspdchyp\) containing
the partial monogamous cospans must be constructed.

\begin{lemma}
    Identities and symmetries are partial monogamous.
\end{lemma}
\begin{proof}
    Identities and symmetries are monogamous by (1) in
    \cref{lem:monogamous-acyclic-preserved} so they must also be partial
    monogamous.
\end{proof}

\begin{lemma}
    Given partial monogamous cospans \(\cospan{\listvar{m}}{F}{\listvar{n}}\)
    and \(\cospan{\listvar{n}}{G}{\listvar{p}}\), \(
        (\cospan{\listvar{m}}{F}{\listvar{n}})
        \seq
        (\cospan{\listvar{n}}{G}{\listvar{p}})
    \) is partial monogamous.
\end{lemma}
\begin{proof}
    By (2), composition preserves monogamicity.
    The only difference between partial monogamous cospans and monogamous ones
    is that the former may have cycles and nodes of degree \((0,0)\) not in the
    interfaces.
    However, since neither of these can be interfaces they cannot be altered by
    composition, so partial monogamy must also be preserved.
\end{proof}

\begin{lemma}
    Given partial monogamous cospans \(\cospan{\listvar{m}}{F}{\listvar{n}}\)
    and \(\cospan{\listvar{p}}{G}{\listvar{q}}\), \(
        (\cospan{\listvar{m}}{F}{\listvar{n}})
        \tensor
        (\cospan{\listvar{n}}{G}{\listvar{p}})
    \) is partial monogamous.
\end{lemma}
\begin{proof}
    As with composition, tensor preserves monogamicity by
    \cite[Lem. 17]{bonchi2022stringa}, and as it does not affect the degree of
    nodes then it preserves partial monogam as well.
\end{proof}

As partial monogamicity is preserved by both forms of composition, the
partial monogamous cospans themselves form a PROP.

\begin{definition}
    Let \(\pmcspdchyp\) be the sub-PROP of \(\cspdchyp\) containing only the
    partial monogamous cospans of hypergraphs.
\end{definition}

Of course, we are not done yet, as we are concerned with \emph{traced} terms:
we must show that \(\pmcspdchyp\) is also traced.

\begin{theorem}
    \label{thm:partial-monogamous-ops}
    \(\pmcspdchyp\) has a trace defined as the trace in \(\cspdchyp\).
\end{theorem}
\begin{proof}
    Consider a partial monogamous cospan \(
        \cospan{\listvar{x} + \listvar{m}}[f + h]{F}[g + k]{\listvar{x} + \listvar{n}}
    \); we must show that its trace \(
        \cospan{\listvar{m}}[h]{F^\prime}[k]{\listvar{n}}
    \) is also partial monogamous.
    Only the vertices in the image of \(f\) and \(g\) are affected by the trace:
    for each element \(a \in \listvar{x}\), \(f(a)\) and \(g(a)\) will be merged
    together in the traced graph, summing their degrees.
    If these vertices are in the image of \(h\) or \(k\) then this will be
    preserved in the traced cospan.

    We now consider the various cases:
    \begin{itemize}
        \item if \(f(a) = g(a)\), then this vertex must have degree \((0, 0)\);
                the traced vertex will still have degree \((0, 0)\) and will no
                longer be in the interface, so will still be partial monogamous;
        \item if \(f(a)\) is also in the image of \(k\) and \(g(i)\) is also in
                the image of \(h\), then both \(f(a)\) and \(g(a)\) have degree
                \((0, 0)\); the traced vertex will still have degree
                \((0, 0)\) and be in both interfaces of the traced cospan, so
                will still be partial monogamous;
        \item if \(f(a)\) is also in the image of \(k\), then \(f(i)\) will have
                degree \((0, 0)\) and \(g(a)\) will have degree \((1,0)\), so
                the traced vertex will have degree \((1, 0)\) and be in the
                image of \(k\); and
        \item if \(g(i)\) is in the image of \(h\), then the above argument
                applies in reverse. \qedhere
    \end{itemize}
\end{proof}

Crucially, while we leave \(\pmcspdhyp\) in order to construct the trace using
the cup and cap, the resulting cospan \emph{is} in \(\pmcspdhyp\).

\subsection{The traced correspondence}

To show that cospans of partial monogamous hypergraphs are a suitable
interpretation of terms in \(\stmcsigmac\), we must show two things.
First we must show that the image of
\(\termandfrobtohypsigma \circ \tracedtosymandfrob{\Sigma}\) is always in
\(\pmcspdchyp\), and then we must show that this mapping is \emph{full} when
restricted to \(\pmcspdhyp\).
For the former, we will use a similar strategy to that used to show the
correspondence between \(\smcsigmac + \frobc\) and \(\cspdchyp\) in
\cref{thm:isomorphism-smcfrob-cospans}; for a given partial monogamous cospan of
hypergraphs we will define an isomorphic composite of components formed from
taking the trace over elements in the image of \(\termtohypsigmac\).

\begin{corollary}
    For a discrete hypergraph \(X \in \hypsigmac\), any monogamous cospan
    \(\cospan{\overline{m}}{X}{\overline{m}}\) is in the image of the unique
    morphism \(\morph{!}{\hat{\permsprop} \slice C}{\cspdchyp}\).
\end{corollary}

Cospans of this for

\begin{theorem}\label{thm:termtohyp-image}
    A cospan \(\cospan{m}{F}{n}\) is in the image of \(
        \termandfrobtohypsigmac \circ \tracedtosymandfrobsigmac\) if
    and only if it is partial monogamous.
\end{theorem}
\begin{proof}
    Since the generators \(\stmcsigmac\) are mapped to monogamous cospans
    by \(\termandfrobtohypsigmac \circ \tracedtosymandfrobsigmac\) and partial
    monogamy is preserved by composition and trace
    (\cref{thm:partial-monogamous-ops}), every cospan in the image of
    \(\termandfrobtohypsigmac \circ \tracedtosymandfrobsigmac\) is partial
    monogamous.

    Now we show that any partial monogamous cospan \(
        \cospan{m}[f]{F}[g]{n}
    \) must be in the image of \(
        \termtohypsigmac \circ \tracedtosymandfrobsigmac
    \) by constructing an isomorphic cospan from a trace of cospans
    The components of the new cospan are as follows:
    \begin{itemize}
        \item let \(L\) be the hypergraph containing vertices with degree
                \((0,0)\) that are not in the image of \(f\) or \(g\);
        \item let \(E\) be the hypergraph containing hyperedges of \(F\) and
                their source and target vertices, but disconnected;
        \item let \(V\) be the discrete hypergraph containing all the
                vertices of \(F\); and
        \item let \(S\) and \(T\) be the discrete hypergraphs containing
                the source and target vertices of hyperedges in \(F\)
                respectively, with the ordering determined by some order
                \(e_1,e_2,\cdots,e_n\) on the edges in \(F\).
    \end{itemize}

    These parts can be composed and a trace applied to obtain the follow
    cospan:
    \begin{gather}
        \trace{T}{
            \cospan{T + m}[\id + f]{V}[\id + g]{S + n}
            \,\seq\,
            \cospan{\emptyset + S + n}[\id]{L + E + n}[\id]{\emptyset + T + n}
        }
        \label{gat:cospan}
    \end{gather}

    This can be checked to be isomorphic to the original cospan
    \(\cospan{m}[f]{F}[g]{n}\) by applying the pushouts.
    From this we can read off a term in \(\stmc{\Sigma}\):
    Since the first cospan is monogamous, it corresponds to a term \(
        \iltikzfig{strings/category/f-2-2}[box=f,colour=white,dom1={|\vertices{T}|},dom2=m,cod1={|\vertices{S}|},cod2=n]
    \) by \cref{lem:monog-discrete-cospan}.
    The second cospan corresponds to \(
        \iltikzfig{strings/category/f}[box=g,colour=white,dom={|\vertices{S}|},cod={|\vertices{T}|}]
        :=
        \bigtensor_{v \in \vertices{L}}
        \iltikzfig{strings/traced/trace-id}
        \tensor
        \bigtensor_{e \in 0 \leq i \leq n}
        \iltikzfig{graphs/isomorphism/label-e}
        \tensor
        \iltikzfig{strings/category/identity}[colour=white,obj=n]
    \), where \(\elabel{}(e)\) is the generator in \(\generators\) that \(e\) is
    labelled with.
    Putting this all together yields \(
        h := \termtohypsigma[\iltikzfig{graphs/isomorphism/construction}]
    \).
    While there may be multiple orderings on the edges, the possible terms
    are equal by sliding and the naturality of symmetry, so there is one
    unique term \(
        \iltikzfig{strings/category/f}[box=h,colour=white]
    \) that corresponds to cospan (\ref{gat:cospan}).
    It is clear by definition that \(
        \termtohypsigma[\iltikzfig{strings/category/f}[box=h,colour=white]]
    \) produces (\ref{gat:cospan}), which is isomorphic to the original
    cospan \(\cospan{m}[f]{F}[g]{n}\), so it is in the image of
    \(\termtohypsigma \circ \tracedtosymandfrob{\Sigma}\).
\end{proof}

This shows that \(
    \termandfrobtohypsigma \circ \tracedtosymandfrob{\Sigma}
\) is a \emph{full} mapping from \(\stmcsigma\) to \(\pmcspdhyp\).
As \(\tracedtosymandfrob{\Sigma}\) is faithful by definition and
\(\termandfrobtohypsigma\) are faithful by \cref{prop:tohyp-faithful}, the
entire mapping is also faithful: \(\stmcsigma\) is mapped to a \emph{unique}
cospan of hypergraphs up to isomorphism.

\begin{corollary}\label{cor:stmc-graph-iso}
    \(\stmc{\Sigma} \cong \pmcspfihyp\).
\end{corollary}