\section{Sequential circuits}

Our intended application for graph rewriting modulo traced
comonoid structure is that of sequential circuits.
Much of the nuance that arises when using the operational semantics is the
treatment of feedback.
In the hypergraph interpretation there is no distinguishing between a wire going
`backwards' or a regular wire, so we must explicitly keep track of traces if we
need to rewrite them later.
To represent this in our diagrams, we will colour any trace source tentacle red.

\begin{example}\label{ex:sr-latch-interpretation}
    Recall the SR NOR latch circuit from \cref{ex:sr-latch}.
    This is interpreted as a partial left-monogamous cospan of hypergraphs as
    follows, where the \(\wedge\), \(\neg\) and \(\delta\) edges respectively
    represent the \(\orgate\) gate, \(\notgate\) gate, and delay.
    \begin{center}
        \begin{tikzcd}[bezier bounding box=true]
            \iltikzfig{graphs/circuits/sr-latch/inputs}
            \arrow{r}
            &
            \iltikzfig{graphs/circuits/sr-latch/latch}
            &
            \arrow{l}
            \iltikzfig{graphs/circuits/sr-latch/outputs}
        \end{tikzcd}
    \end{center}
\end{example}

Since the transformation into global trace-delay form is purely through axioms
of STMCs, in the hypergraph interpretation a circuit and corrsponding
trace-delay form are isomorphic.

\begin{example}
    We may suggestively adjust the positioning of the nodes and vertices in
    order to evoke an idea of global trace-delay form, but the graph
    interpretation of the SR NOR latch from \cref{ex:sr-latch-interpretation}
    remains the same.
    Note that although the red tentacle no longer looks like a trace, we still
    keep track of it with the red tentacle.
    Moreover, even though the source of the delay looks like a trace in the
    diagram, it is not marked as such; this reflects how this loop has been
    introduced through yanking and as such is not a true non-delay-guarded
    feedback loop.
    \begin{center}
        \begin{tikzcd}[bezier bounding box=true]
            \iltikzfig{graphs/circuits/sr-latch/inputs}
            \arrow{r}
            &
            \iltikzfig{graphs/circuits/sr-latch/global}
            &
            \arrow{l}
            \iltikzfig{graphs/circuits/sr-latch/outputs}
        \end{tikzcd}
    \end{center}
\end{example}

The first rewrite that needs to be applied is the global Mealy reduction
\((\mealyeqn)\).
As this is a reduction parameterised over an arbitrary core \(
\iltikzfig{strings/category/f-3-3}[box=f]
\), it actually specifies a \emph{family} of rewrites, one for each possible
core.

\begin{example}\label{ex:sr-latch-mealy-graph}
    Applying the Mealy rewrite to the SR latch graph produces the following
    cospan.
    \begin{center}
        \begin{tikzcd}[bezier bounding box=true]
            \iltikzfig{graphs/circuits/sr-latch/inputs}
            \arrow{r}
            &
            \iltikzfig{graphs/circuits/sr-latch/mealy}
            &
            \arrow{l}
            \iltikzfig{graphs/circuits/sr-latch/outputs}
        \end{tikzcd}
    \end{center}
\end{example}

When performing the instant feedback reduction on terms, it can lead to a
complicated term with the inputs forked multiple times in order to pass them to
each of the copies of the original circuit.
In the hypergraph representation, the forks are all absorbed into one.

\begin{example}\label{ex:instant-feedback-rewrite}
    Below is an example showing how the instant feedback rewrite is applied to
    a circuit in Mealy form containing one generator \(e\).
    \begin{center}
        \includestandalone{figures/graphs/circuits/unroll/rewrite}
    \end{center}
\end{example}

As the instant feedback rule eliminates non-delay-guarded feedback loops, there
are no red tentacles in the right hand side of the rule or the rewritten graph.

\begin{example}\label{ex:sr-latch-instant-feedback-graph}
    The interpretation of the SR latch from \cref{ex:sr-latch-mealy-graph}
    after being rewritten by the instant feedback rewrite is shown below.
    \begin{center}
        \begin{tikzcd}[bezier bounding box=true, column sep=tiny]
            \iltikzfig{graphs/circuits/sr-latch/inputs}
            \arrow{r}
            &
            \iltikzfig{graphs/circuits/sr-latch/instant-feedback}
            &
            \arrow{l}
            \iltikzfig{graphs/circuits/sr-latch/outputs}
        \end{tikzcd}
    \end{center}
\end{example}

After performing the instant feedback rewrite, the graph is ready to receive
inputs.
As with the string diagrammatic procedure, we precompose the graph with some
inputs and perform the streaming rewrite.

\begin{example}\label{ex:sr-latch-streaming-graph}
    We apply the inputs \(\belnaptrue\belnapfalse\) to the prepared SR latch
    hypergraph from \cref{ex:sr-latch-instant-feedback-graph} by precomposing
    some value registers.
    \begin{center}
        \begin{tikzcd}[bezier bounding box=true, column sep=tiny]
            \iltikzfig{graphs/circuits/sr-latch/inputs}
            \arrow{r}
            &
            \iltikzfig{graphs/circuits/sr-latch/applied}
            &
            \arrow{l}
            \iltikzfig{graphs/circuits/sr-latch/outputs}
        \end{tikzcd}
    \end{center}
    This graph is then rewritten by the streaming rule.
    \begin{center}
        \vspace{-1em}
        \begin{tikzcd}[bezier bounding box=true, column sep=tiny]
            \iltikzfig{graphs/circuits/sr-latch/inputs}
            \arrow{r}
            &
            \iltikzfig{graphs/circuits/sr-latch/streamed}
            &
            \arrow{l}
            \iltikzfig{graphs/circuits/sr-latch/outputs}
        \end{tikzcd}
    \end{center}
\end{example}

The final step is to propgate the values across the `top' subcircuit using the
value rules, which have straightforward hypergraph interpretations.

\begin{center}
    \includestandalone{figures/graphs/circuits/gate/rule}
    \quad
    \includestandalone{figures/graphs/circuits/fork-rewrite/rule}
    \\
    \includestandalone{figures/graphs/circuits/join/rule}
    \quad
    \raisebox{0.6em}{\includestandalone{figures/graphs/circuits/stub/rule}}
\end{center}


\begin{example}
    When applying the value rules to the streamed circuit from
    \cref{ex:sr-latch-streaming-graph}, we apply the fork rules as much as
    possible to propagate the values:
    \begin{center}
        \begin{tikzcd}[bezier bounding box=true, column sep=tiny]
            \iltikzfig{graphs/circuits/sr-latch/inputs}
            \arrow{r}
            &
            \iltikzfig{graphs/circuits/sr-latch/values-1}
            &
            \arrow{l}
            \iltikzfig{graphs/circuits/sr-latch/outputs}
        \end{tikzcd}
    \end{center}
    We can then repeatedly apply the gate rule and the eliminate room to obtain
    the outputs and next state.
    \begin{center}
        \begin{tikzcd}[bezier bounding box=true, column sep=tiny]
            \iltikzfig{graphs/circuits/sr-latch/inputs}
            \arrow{r}
            &
            \iltikzfig{graphs/circuits/sr-latch/values-2}l
            &
            \arrow{l}
            \iltikzfig{graphs/circuits/sr-latch/outputs}
        \end{tikzcd}
    \end{center}
\end{example}

\begin{remark}
    Note that the fork rule is not left-linear as it uses the comonoid
    structure; this can lead to a small issue when performing the operational
    semantics.
    Consider the term \(
    \iltikzfig{graphs/circuits/fork-rewrite/term-g}
    \); in the hypergraph interpretation it is possible to apply the fork rule
    to this term.
    \begin{gather*}
        \includestandalone{figures/graphs/circuits/fork-rewrite/fork-rewrite}
    \end{gather*}
    This reduction has arisen due to the counitality of the comonoid.
    \begin{gather*}
        \iltikzfig{graphs/circuits/fork-rewrite/term-g}
        =
        \iltikzfig{graphs/circuits/fork-rewrite/term-g-1}
        \reduction
        \iltikzfig{graphs/circuits/fork-rewrite/term-h}
    \end{gather*}
    This means that care must be taken when performing the reduction procedure;
    a fork rewrite is only productive if the vertex in the image of \(f\) has
    out-degree strictly greater than \(1\).
    If we arbitrarily any rewrite we find, we may end up stuck in a loop of
    forking and stubbing the same subcircuit.
\end{remark}

\begin{remark}
    Another scenario that looks like it might cause issues is when considering
    a value connected to the outputs of a term.
    \begin{gather*}
        \iltikzfig{circuits/components/values/vs}
        \qquad
        \iltikzfig{graphs/circuits/stub/g}
    \end{gather*}
    It might seem like the elimination rule can be applied here and delete the
    value connected to the interface.
    However, this is forbidden by DPO rewriting \emph{with interfaces}; there
    are no maps from the interface to the context or the rewritten graph so this
    cannot be a valid rewrite.
    \begin{center}
        \includestandalone{figures/graphs/circuits/stub/rewrite}
    \end{center}
\end{remark}